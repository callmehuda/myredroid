name: Redroid

on:
  push:
    branches: [ "re-image" ]
  workflow_dispatch:

jobs:
  my:
    runs-on: ubuntu-latest
    # Timeout global agar Actions tidak mati duluan sebelum backup selesai
    timeout-minutes: 360 

    steps:
      - uses: actions/checkout@v4
      
      - name: Install Cloudflared
        run: |       
          sudo mkdir -p --mode=0755 /usr/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt-get update && sudo apt-get install cloudflared -y

      - name: Install Other Dependencies
        run: |       
          sudo apt-get update
          sudo apt-get install rclone zstd adb fish -y
          # Install TTYD
          wget https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64
          chmod +x ttyd.x86_64 && sudo mv ttyd.x86_64 /usr/bin/ttyd

      - name: Setup Rclone & Restore Data
        run: |
          mkdir -p ~/.config/rclone
          # Pakai rclone.conf yang ada di repo kamu
          [ -f rclone.conf ] && cp rclone.conf ~/.config/rclone/rclone.conf
          
          echo "Checking for existing backup on GDrive..."
          # Ambil backup terakhir jika ada
          if rclone ls gdrive:Redroid_Backups/redroid_backup.tar.zst; then
            rclone copy gdrive:Redroid_Backups/redroid_backup.tar.zst . -P
            tar --use-compress-program=zstd -xvf redroid_backup.tar.zst
            echo "Restore complete!"
          else
            echo "No backup found, starting fresh."
            mkdir -p data/media/0/Download
            wget https://f-droid.org/repo/com.aurora.store_71.apk -O data/media/0/Download/Aurora.apk
          fi

      - name: Setup Network & Tunnels
        run: |
          # Pakai service install & token milikmu
          #sudo cloudflared service install eyJhIjoiOWFjMWUxOTExMmU5ZWZmZDIzNmFlNDk1NDIyYmY2ZjgiLCJ0IjoiZmJiNzE4ODUtNjY0ZS00NTg3LWFjYTgtMWYxZjY4NjI4MDYxIiwicyI6Ik9HRXdaVEU1WldJdE5ESm1ZeTAwTXpaaUxXRXpZakF0TUdVM1ltWTNNR0ZpTURsbSJ9
          cloudflared tunnel run --token eyJhIjoiOWFjMWUxOTExMmU5ZWZmZDIzNmFlNDk1NDIyYmY2ZjgiLCJ0IjoiZmJiNzE4ODUtNjY0ZS00NTg3LWFjYTgtMWYxZjY4NjI4MDYxIiwicyI6Ik9HRXdaVEU1WldJdE5ESm1ZeTAwTXpaaUxXRXpZakF0TUdVM1ltWTNNR0ZpTURsbSJ9 &
          ttyd -p 5678 -W -t cursorStyle=bar /usr/bin/fish &
          
      - name: Setup Kernel & Redroid
        run: |
          sudo apt install linux-modules-extra-`uname -r`
          sudo modprobe binder_linux devices="binder,hwbinder,vndbinder"
          docker pull erstt/redroid:15.0.0_ndk_magisk_litegapps_AVD

      - name: Run Redroid (4 Hour Limit)
        continue-on-error: true
        run: |
          # Jalankan docker-compose dengan timeout 4 jam (14400 detik)
          timeout 14400s docker compose up || echo "Redroid reached 4 hour limit."

      - name: Stop, Compress & Backup
        if: always() # Tetap jalan meski timeout
        run: |
          echo "Cleaning up containers..."
          docker compose down || true
          
          echo "Compressing data folder..."
          sudo tar --use-compress-program="zstd -3 --threads=0" -cvf redroid_backup.tar.zst data/
          
          echo "Uploading to Google Drive..."
          sudo rclone copy redroid_backup.tar.zst gdrive:Redroid_Backups/ -P
